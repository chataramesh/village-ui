<div class="user-create-container">
  
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" (click)="goBack()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
      Back
    </button>
    <div class="header-content">
      <h1 class="page-title">
        <span class="title-icon">{{ isEditMode ? '‚úèÔ∏è' : '‚ûï' }}</span>
        {{getPageTitle()}}
      </h1>
      <p class="page-subtitle">{{ isEditMode ? 'Update user information' : 'Add a new user to the system' }}</p>
    </div>
  </div>

  <!-- Form Section -->
  <div class="form-section">
    <form #userForm="ngForm" (ngSubmit)="onSubmit()">
      
      <!-- Personal Information -->
      <div class="form-group-section">
        <h2 class="section-title">
          <span class="section-icon">üë§</span>
          Personal Information
        </h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="name" class="form-label">
              Full Name <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <input 
                type="text" 
                id="name" 
                name="name"
                class="form-input"
                placeholder="Enter full name"
                [(ngModel)]="user.name"
                required
                #nameField="ngModel"
                [class.error]="nameField.invalid && nameField.touched">
            </div>
            <span class="error-message" *ngIf="nameField.invalid && nameField.touched">
              Name is required
            </span>
          </div>

          <div class="form-group">
            <label for="phone" class="form-label">
              Phone Number <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              <input 
                type="tel" 
                id="phone" 
                name="phone"
                class="form-input"
                placeholder="+91 98765 43210"
                [(ngModel)]="user.phone"
                required
                pattern="^[\+]?[0-9\s\-\(\)]+$"
                #phoneField="ngModel"
                [class.error]="phoneField.invalid && phoneField.touched">
            </div>
            <span class="error-message" *ngIf="phoneField.invalid && phoneField.touched">
              Valid phone number is required
            </span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="email" class="form-label">
              Email Address <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
              </svg>
              <input 
                type="email" 
                id="email" 
                name="email"
                class="form-input"
                placeholder="user@example.com"
                [(ngModel)]="user.email"
                required
                email
                #emailField="ngModel"
                [class.error]="emailField.invalid && emailField.touched">
            </div>
            <span class="error-message" *ngIf="emailField.invalid && emailField.touched">
              Valid email is required
            </span>
          </div>

          <div class="form-group" *ngIf="!isEditMode">
            <label for="password" class="form-label">
              Password <span class="required">*</span>
            </label>
            <div class="input-wrapper">
              <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              <input 
                [type]="showPassword ? 'text' : 'password'" 
                id="password" 
                name="password"
                class="form-input"
                placeholder="Enter password"
                [(ngModel)]="user.passwordHash"
                [required]="!isEditMode"
                minlength="4"
                #passwordField="ngModel"
                [class.error]="passwordField.invalid && passwordField.touched">
              <button type="button" class="toggle-password" (click)="togglePassword()">
                <svg *ngIf="!showPassword" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <svg *ngIf="showPassword" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                </svg>
              </button>
            </div>
            <span class="error-message" *ngIf="passwordField.invalid && passwordField.touched">
              Password must be at least 6 characters
            </span>
          </div>
        </div>
      </div>

      <!-- Role & Access -->
      <div class="form-group-section">
        <h2 class="section-title">
          <span class="section-icon">üîê</span>
          Role & Access
        </h2>
        
        <div class="form-row">
          <div class="form-group">
            <label for="role" class="form-label">
              User Role <span class="required">*</span>
            </label>
            <div class="select-wrapper">
              <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
              </svg>
              <select 
                id="role" 
                name="role"
                class="form-select"
                [(ngModel)]="user.role"
                (change)="onRoleChange()"
                required
                #roleField="ngModel"
                [class.error]="roleField.invalid && roleField.touched"
                [disabled]="contextRole !== null">
                <option value="" disabled>Select a role</option>
                <option *ngFor="let role of availableRoles" [value]="role">
                  {{role === Role.VILLAGE_ADMIN ? 'Village Admin' : (role === Role.VILLAGER ? 'Villager' : 'Super Admin')}}
                </option>
              </select>
            </div>
            <span class="error-message" *ngIf="roleField.invalid && roleField.touched">
              Role is required
            </span>
          </div>
        </div>

        <!-- Location Selection Section -->
        <div class="form-group">
          <label class="form-label">
            Location Selection <span class="required" *ngIf="showVillageDropdown">*</span>
          </label>

          <!-- Country Selection -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Country</label>
              <div class="select-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="dropdown" [class.open]="countryOpen">
                  <button type="button" class="dropdown-control" (click)="toggleCountry()">
                    <span class="dropdown-value">{{ selectedCountryId ? (getCountryNameById(selectedCountryId) || 'Selected') : 'Select a country' }}</span>
                    <span class="dropdown-caret">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </span>
                  </button>
                  <div class="dropdown-menu" *ngIf="countryOpen">
                    <div class="dropdown-search">
                      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                      <input name="countrySearch" class="dropdown-search-input" type="text" [(ngModel)]="countrySearch" [ngModelOptions]="{standalone: true}" placeholder="Search countries..." autocomplete="off"/>
                    </div>
                    <div class="dropdown-list">
                      <button class="dropdown-item" *ngFor="let country of filteredCountries" (click)="selectCountry(country.id)">{{country.name}}</button>
                      <div class="dropdown-empty" *ngIf="filteredCountries.length === 0">No countries found</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- State Selection -->
            <div class="form-group">
              <label class="form-label">State</label>
              <div class="select-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                </svg>
                <div class="dropdown" [class.open]="stateOpen">
                  <button type="button" class="dropdown-control" [class.disabled]="!selectedCountryId || states.length===0" (click)="$event.stopPropagation(); (selectedCountryId && states.length>0) ? toggleState() : null">
                    <span class="dropdown-value">{{ selectedStateId ? (getStateNameById(selectedStateId) || 'Selected') : (!selectedCountryId ? 'Select country first' : (states.length===0 ? 'Loading states...' : 'Select a state')) }}</span>
                    <span class="dropdown-caret">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </span>
                  </button>
                  <div class="dropdown-menu" *ngIf="stateOpen">
                    <div class="dropdown-search">
                      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                      <input name="stateSearch" class="dropdown-search-input" type="text" [(ngModel)]="stateSearch" [ngModelOptions]="{standalone: true}" placeholder="Search states..." autocomplete="off"/>
                    </div>
                    <div class="dropdown-list">
                      <button class="dropdown-item" *ngFor="let state of filteredStates" (click)="selectState(state.id)">{{state.name}}</button>
                      <div class="dropdown-empty" *ngIf="filteredStates.length === 0">No states found</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- District Selection -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">District</label>
              <div class="select-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                </svg>
                <div class="dropdown" [class.open]="districtOpen">
                  <button type="button" class="dropdown-control" [class.disabled]="!selectedStateId || districts.length===0" (click)="$event.stopPropagation(); (selectedStateId && districts.length>0) ? toggleDistrict() : null">
                    <span class="dropdown-value">{{ selectedDistrictId ? (getDistrictNameById(selectedDistrictId) || 'Selected') : (!selectedStateId ? 'Select state first' : (districts.length===0 ? 'Loading districts...' : 'Select a district')) }}</span>
                    <span class="dropdown-caret">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </span>
                  </button>
                  <div class="dropdown-menu" *ngIf="districtOpen">
                    <div class="dropdown-search">
                      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                      <input name="districtSearch" class="dropdown-search-input" type="text" [(ngModel)]="districtSearch" [ngModelOptions]="{standalone: true}" placeholder="Search districts..." autocomplete="off"/>
                    </div>
                    <div class="dropdown-list">
                      <button class="dropdown-item" *ngFor="let district of filteredDistricts" (click)="selectDistrict(district.id)">{{district.name}}</button>
                      <div class="dropdown-empty" *ngIf="filteredDistricts.length === 0">No districts found</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mandal Selection -->
            <div class="form-group">
              <label class="form-label">Mandal</label>
              <div class="select-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <div class="dropdown" [class.open]="mandalOpen">
                  <button type="button" class="dropdown-control" [class.disabled]="!selectedDistrictId || mandals.length===0" (click)="$event.stopPropagation(); (selectedDistrictId && mandals.length>0) ? toggleMandal() : null">
                    <span class="dropdown-value">{{ selectedMandalId ? (getMandalNameById(selectedMandalId) || 'Selected') : (!selectedDistrictId ? 'Select district first' : (mandals.length===0 ? 'Loading mandals...' : 'Select a mandal')) }}</span>
                    <span class="dropdown-caret">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </span>
                  </button>
                  <div class="dropdown-menu" *ngIf="mandalOpen">
                    <div class="dropdown-search">
                      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                      <input name="mandalSearch" class="dropdown-search-input" type="text" [(ngModel)]="mandalSearch" [ngModelOptions]="{standalone: true}" placeholder="Search mandals..." autocomplete="off"/>
                    </div>
                    <div class="dropdown-list">
                      <button class="dropdown-item" *ngFor="let mandal of filteredMandals" (click)="selectMandal(mandal.id)">{{mandal.name}}</button>
                      <div class="dropdown-empty" *ngIf="filteredMandals.length === 0">No mandals found</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Village Selection -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Village</label>
              <div class="select-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                </svg>
                <div class="dropdown" [class.open]="villageOpen">
                  <button type="button" class="dropdown-control" [class.disabled]="!selectedMandalId || villages.length===0" (click)="$event.stopPropagation(); (selectedMandalId && villages.length>0) ? toggleVillage() : null">
                    <span class="dropdown-value">{{ selectedVillageId ? (getVillageNameById(selectedVillageId) || 'Selected') : (!selectedMandalId ? 'Select mandal first' : (villages.length===0 ? 'Loading villages...' : 'Select a village')) }}</span>
                    <span class="dropdown-caret">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </span>
                  </button>
                  <div class="dropdown-menu" *ngIf="villageOpen">
                    <div class="dropdown-search">
                      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                      <input name="villageSearch" class="dropdown-search-input" type="text" [(ngModel)]="villageSearch" [ngModelOptions]="{standalone: true}" placeholder="Search villages..." autocomplete="off"/>
                    </div>
                    <div class="dropdown-list">
                      <button class="dropdown-item" *ngFor="let village of filteredVillages" (click)="selectVillage(village.id || '')">{{village.name}}</button>
                      <div class="dropdown-empty" *ngIf="filteredVillages.length === 0">No villages found</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="checkbox-label">
              <input
                type="checkbox"
                name="active"
                class="form-checkbox"
                [(ngModel)]="user.active">
              <span class="checkbox-text">
                <span class="checkbox-title">Active User</span>
                <span class="checkbox-description">User can login and access the system</span>
              </span>
            </label>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onReset()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Reset
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || isSubmitting">
          <svg *ngIf="!isSubmitting" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M5 13l4 4L19 7"></path>
          </svg>
          <svg *ngIf="isSubmitting" class="spinner" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {{ isSubmitting ? 'Saving...' : (isEditMode ? 'Update User' : getCreateButtonText()) }}
        </button>
      </div>

    </form>
  </div>

</div>
