"use strict";(self.webpackChunkvillage_ui=self.webpackChunkvillage_ui||[]).push([[175],{1825:(v,m,r)=>{r.d(m,{m:()=>c});var _=r(4412),C=r(1413),g=r(1985),t=r(2869),p=r(25),O=r(5312),s=r(2598),M=r(629);let c=(()=>{class f{constructor(o){this.tokenService=o,this.stompClient=null,this.connected=new _.t(!1),this.notifications=new _.t([]),this.unreadCount=new _.t(0),this.entitySubscriptions=new Set,this.destroy$=new C.B,this.initializeWebSocket()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.disconnect()}initializeWebSocket(){const o=this.tokenService.getToken();if(!o)return void console.warn("No authentication token found for WebSocket connection");const e=new p(`${O.c.apiUrl}/ws`);this.stompClient=new t.K({webSocketFactory:()=>e,connectHeaders:{Authorization:`Bearer ${o}`},debug:n=>{console.log("STOMP Debug:",n)},reconnectDelay:5e3,heartbeatIncoming:4e3,heartbeatOutgoing:4e3}),this.stompClient.onConnect=n=>{console.log("WebSocket Connected:",n),this.connected.next(!0),this.subscribeToPersonalNotifications(),this.subscribeToAllEntityUpdates()},this.stompClient.onStompError=n=>{console.error("STOMP Error:",n.headers.message),console.error("Error details:",n.body),this.connected.next(!1)},this.stompClient.onWebSocketClose=()=>{console.log("WebSocket connection closed"),this.connected.next(!1)},this.stompClient.onDisconnect=()=>{console.log("WebSocket disconnected"),this.connected.next(!1)},this.stompClient.activate()}subscribeToPersonalNotifications(){this.stompClient?.connected&&this.stompClient.subscribe("/user/queue/notifications",o=>{try{const e=JSON.parse(o.body);console.log("Received personal notification:",e),this.addNotification(e)}catch(e){console.error("Error parsing notification:",e)}})}subscribeToAllEntityUpdates(){this.stompClient?.connected&&this.stompClient.subscribe("/topic/entity-updates",o=>{try{const e=JSON.parse(o.body);console.log("Received entity update notification:",e),this.addNotification(e)}catch(e){console.error("Error parsing entity update notification:",e)}})}subscribeToEntityUpdates(o){this.stompClient?.connected?this.entitySubscriptions.has(o)?console.log(`Already subscribed to entity ${o} updates`):(this.stompClient.subscribe(`/topic/entity/${o}/notifications`,e=>{try{const n=JSON.parse(e.body);console.log(`Received entity ${o} notification:`,n),this.addNotification(n)}catch(n){console.error("Error parsing entity notification:",n)}}),this.entitySubscriptions.add(o),console.log(`Subscribed to entity ${o} updates`)):console.warn("WebSocket not connected, cannot subscribe to entity updates")}unsubscribeFromEntityUpdates(o){this.stompClient?.connected&&(this.entitySubscriptions.delete(o),console.log(`Unsubscribed from entity ${o} updates`))}addNotification(o){const e=this.notifications.value,n=e.findIndex(l=>l.id===o.id);n>=0?e[n]=o:(e.unshift(o),e.length>50&&e.pop(),o.isRead||this.unreadCount.next(this.unreadCount.value+1)),this.notifications.next([...e])}markNotificationAsRead(o){const e=this.notifications.value,n=e.findIndex(l=>l.id===o);return n>=0&&!e[n].isRead&&(e[n].isRead=!0,this.notifications.next([...e]),this.unreadCount.next(Math.max(0,this.unreadCount.value-1))),new g.c(l=>{l.next({success:!0}),l.complete()})}clearAllNotifications(){this.notifications.next([]),this.unreadCount.next(0)}getNotifications(){return this.notifications.asObservable()}getUnreadCount(){return this.unreadCount.asObservable()}isConnected(){return this.connected.asObservable()}disconnect(){this.stompClient?.connected&&this.stompClient.deactivate(),this.connected.next(!1),this.entitySubscriptions.clear()}reconnect(){this.disconnect(),setTimeout(()=>{this.initializeWebSocket()},1e3)}requestNotificationPermission(){return"Notification"in window?Notification.requestPermission():Promise.resolve("denied")}showBrowserNotification(o){if("Notification"in window&&"granted"===Notification.permission){const e=new Notification(o.title,{body:o.message,icon:"/assets/notification-icon.png",badge:"/assets/notification-badge.png",tag:o.id,requireInteraction:"HIGH"===o.priority,silent:"LOW"===o.priority});e.onclick=()=>{window.focus(),e.close()},"HIGH"!==o.priority&&setTimeout(()=>{e.close()},5e3)}}static{this.\u0275fac=function(e){return new(e||f)(s.KVO(M.B))}}static{this.\u0275prov=s.jDH({token:f,factory:f.\u0275fac,providedIn:"root"})}}return f})()},7967:(v,m,r)=>{r.d(m,{Tr:()=>O,ck:()=>b,cx:()=>p});var _=r(6354),C=r(5312),g=r(2598),t=r(1626),p=function(s){return s.OPEN="OPEN",s.CLOSED="CLOSED",s.UNDER_MAINTENANCE="UNDER_MAINTENANCE",s.TEMPORARILY_CLOSED="TEMPORARILY_CLOSED",s.PERMANENTLY_CLOSED="PERMANENTLY_CLOSED",s}(p||{}),b=function(s){return s.GOVT_HOSPITAL="GOVT_HOSPITAL",s.SHOP="SHOP",s.MRO_OFFICE="MRO_OFFICE",s.POLICE_STATION="POLICE_STATION",s.POST_OFFICE="POST_OFFICE",s.SCHOOL="SCHOOL",s.BANK="BANK",s.PHARMACY="PHARMACY",s.COMMUNITY_CENTER="COMMUNITY_CENTER",s.OTHER="OTHER",s}(b||{});let O=(()=>{class s{constructor(c){this.http=c,this.apiUrl=`${C.c.apiUrl}/entities`}getAllEntities(){return this.http.get(`${this.apiUrl}/all`)}getEntityById(c){return this.http.get(`${this.apiUrl}/${c}`)}getEntitiesByType(c){return this.http.get(`${this.apiUrl}/type/${c}`)}getEntitiesByOwner(c){return this.http.get(`${this.apiUrl}/owner/${c}`)}getEntitiesByVillage(c){return this.http.get(`${this.apiUrl}/village/${c}`)}getEntitiesByStatus(c){return this.http.get(`${this.apiUrl}/status/${c}`)}createEntity(c){return this.http.post(`${this.apiUrl}/create`,c)}updateEntity(c,f){return this.http.put(`${this.apiUrl}/${c}`,f)}updateEntityByOwner(c,f,P){return this.http.put(`${this.apiUrl}/${c}/${f}`,P)}deleteEntity(c){return this.http.delete(`${this.apiUrl}/${c}`,{responseType:"text"}).pipe((0,_.T)(()=>{}))}getEntityStats(){return this.http.get(`${this.apiUrl}/stats`)}searchEntities(c){return this.http.get(`${this.apiUrl}/search`,{params:{q:c}})}static{this.\u0275fac=function(f){return new(f||s)(g.KVO(t.Qq))}}static{this.\u0275prov=g.jDH({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})()},1457:(v,m,r)=>{r.d(m,{w:()=>e});var _=r(177),C=r(1413),g=r(6977),t=r(2598),p=r(1825);function b(n,l){1&n&&(t.qSk(),t.nrm(0,"path",15))}function O(n,l){if(1&n&&(t.qSk(),t.joV(),t.j41(0,"span",16),t.EFF(1),t.k0s()),2&n){const i=t.XpG();t.R7$(1),t.SpI(" ",i.unreadCount>99?"99+":i.unreadCount," ")}}function s(n,l){if(1&n){const i=t.RV6();t.j41(0,"button",17),t.bIt("click",function(){t.eBV(i);const a=t.XpG();return t.Njj(a.markAllAsRead())}),t.qSk(),t.j41(1,"svg",2),t.nrm(2,"path",18),t.k0s()()}}function M(n,l){if(1&n){const i=t.RV6();t.j41(0,"button",32),t.bIt("click",function(a){t.eBV(i);const h=t.XpG().$implicit;return t.XpG(2).markAsRead(h.id),t.Njj(a.stopPropagation())}),t.qSk(),t.j41(1,"svg",2),t.nrm(2,"path",18),t.k0s()()}}function c(n,l){if(1&n){const i=t.RV6();t.j41(0,"div",21),t.bIt("click",function(){const h=t.eBV(i).$implicit,u=t.XpG(2);return t.Njj(u.markAsRead(h.id))}),t.j41(1,"div",22),t.qSk(),t.j41(2,"svg",2),t.nrm(3,"path",23),t.k0s()(),t.joV(),t.j41(4,"div",24)(5,"div",25),t.EFF(6),t.k0s(),t.j41(7,"div",26),t.EFF(8),t.k0s(),t.j41(9,"div",27)(10,"span",28),t.EFF(11),t.k0s(),t.j41(12,"span",29),t.EFF(13),t.k0s()()(),t.j41(14,"div",30),t.DNE(15,M,3,0,"button",31),t.k0s()()}if(2&n){const i=l.$implicit,d=t.XpG(2);t.AVh("unread",!i.isRead),t.R7$(1),t.HbH(i.notificationType.toLowerCase()),t.R7$(5),t.JRh(i.title),t.R7$(2),t.JRh(i.message),t.R7$(3),t.JRh(i.entityName),t.R7$(2),t.JRh(d.formatTime(i.createdAt)),t.R7$(2),t.Y8G("ngIf",!i.isRead)}}function f(n,l){if(1&n&&(t.qSk(),t.joV(),t.j41(0,"div",19),t.DNE(1,c,16,9,"div",20),t.k0s()),2&n){const i=t.XpG();t.R7$(1),t.Y8G("ngForOf",i.notifications.slice(0,10))}}function P(n,l){1&n&&(t.qSk(),t.joV(),t.j41(0,"div",33)(1,"div",34),t.qSk(),t.j41(2,"svg",2),t.nrm(3,"path",3),t.k0s()(),t.joV(),t.j41(4,"p"),t.EFF(5,"No notifications yet"),t.k0s()())}function o(n,l){if(1&n){const i=t.RV6();t.qSk(),t.joV(),t.j41(0,"div",35)(1,"button",36),t.bIt("click",function(){t.eBV(i);const a=t.XpG();return t.Njj(a.viewAllNotifications())}),t.EFF(2," View All Notifications "),t.k0s()()}}let e=(()=>{class n{constructor(i){this.notificationService=i,this.destroy$=new C.B,this.notifications=[],this.unreadCount=0,this.showDropdown=!1,this.isConnected=!1}ngOnInit(){this.notificationService.getNotifications().pipe((0,g.Q)(this.destroy$)).subscribe(i=>{this.notifications=i}),this.notificationService.getUnreadCount().pipe((0,g.Q)(this.destroy$)).subscribe(i=>{this.unreadCount=i}),this.notificationService.isConnected().pipe((0,g.Q)(this.destroy$)).subscribe(i=>{this.isConnected=i}),this.notificationService.requestNotificationPermission(),document.addEventListener("click",i=>{i.target.closest(".notification-bell-container")||(this.showDropdown=!1)})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),document.removeEventListener("click",()=>{})}toggleNotifications(){this.showDropdown=!this.showDropdown}markAsRead(i){this.notificationService.markNotificationAsRead(i).pipe((0,g.Q)(this.destroy$)).subscribe()}markAllAsRead(){this.notifications.filter(i=>!i.isRead).forEach(i=>{this.markAsRead(i.id)})}clearAllNotifications(){this.notificationService.clearAllNotifications()}viewAllNotifications(){console.log("View all notifications"),this.showDropdown=!1}formatTime(i){const d=new Date(i),h=Math.floor(((new Date).getTime()-d.getTime())/6e4);if(h<1)return"Just now";if(h<60)return`${h}m ago`;const u=Math.floor(h/60);if(u<24)return`${u}h ago`;const k=Math.floor(u/24);return k<7?`${k}d ago`:d.toLocaleDateString()}static{this.\u0275fac=function(d){return new(d||n)(t.rXU(p.m))}}static{this.\u0275cmp=t.VBU({type:n,selectors:[["app-notification-bell"]],standalone:!0,features:[t.aNF],decls:19,vars:10,consts:[[1,"notification-bell-container"],["title","Notifications",1,"notification-bell",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 17h5l-5 5-5-5h5V12h-5l5-5 5 5h-5v5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 17l.01 0M15 17h.01M12 17h.01M12 2v1m0 18v1m9-9h1M2 12h1m0-8l1 1m16-1l1 1M4.05 4.05l1.414 1.414M17.536 17.536l1.414 1.414M17.536 4.464l-1.414 1.414M4.464 17.536l-1.414 1.414",4,"ngIf"],["class","notification-badge",4,"ngIf"],[1,"notifications-dropdown"],[1,"notifications-header"],[1,"notifications-actions"],["class","mark-all-read-btn","title","Mark all as read",3,"click",4,"ngIf"],["title","Clear all notifications",1,"clear-all-btn",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"],["class","notifications-list",4,"ngIf","ngIfElse"],["noNotifications",""],["class","notifications-footer",4,"ngIf"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M9 17l.01 0M15 17h.01M12 17h.01M12 2v1m0 18v1m9-9h1M2 12h1m0-8l1 1m16-1l1 1M4.05 4.05l1.414 1.414M17.536 17.536l1.414 1.414M17.536 4.464l-1.414 1.414M4.464 17.536l-1.414 1.414"],[1,"notification-badge"],["title","Mark all as read",1,"mark-all-read-btn",3,"click"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M5 13l4 4L19 7"],[1,"notifications-list"],["class","notification-item",3,"unread","click",4,"ngFor","ngForOf"],[1,"notification-item",3,"click"],[1,"notification-icon"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M13 10V3L4 14h7v7l9-11h-7z"],[1,"notification-content"],[1,"notification-title"],[1,"notification-message"],[1,"notification-meta"],[1,"notification-entity"],[1,"notification-time"],[1,"notification-actions"],["class","mark-read-btn","title","Mark as read",3,"click",4,"ngIf"],["title","Mark as read",1,"mark-read-btn",3,"click"],[1,"no-notifications"],[1,"no-notifications-icon"],[1,"notifications-footer"],[1,"view-all-btn",3,"click"]],template:function(d,a){if(1&d&&(t.j41(0,"div",0)(1,"button",1),t.bIt("click",function(){return a.toggleNotifications()}),t.qSk(),t.j41(2,"svg",2),t.nrm(3,"path",3),t.DNE(4,b,1,0,"path",4),t.k0s(),t.DNE(5,O,2,1,"span",5),t.k0s(),t.joV(),t.j41(6,"div",6)(7,"div",7)(8,"h3"),t.EFF(9,"Notifications"),t.k0s(),t.j41(10,"div",8),t.DNE(11,s,3,0,"button",9),t.j41(12,"button",10),t.bIt("click",function(){return a.clearAllNotifications()}),t.qSk(),t.j41(13,"svg",2),t.nrm(14,"path",11),t.k0s()()()(),t.DNE(15,f,2,1,"div",12),t.DNE(16,P,6,0,"ng-template",null,13,t.C5r),t.DNE(18,o,3,0,"div",14),t.k0s()()),2&d){const h=t.sdS(17);t.R7$(1),t.AVh("has-unread",a.unreadCount>0),t.R7$(3),t.Y8G("ngIf",a.unreadCount>0),t.R7$(1),t.Y8G("ngIf",a.unreadCount>0),t.R7$(1),t.AVh("show",a.showDropdown),t.R7$(5),t.Y8G("ngIf",a.unreadCount>0),t.R7$(4),t.Y8G("ngIf",a.notifications.length>0)("ngIfElse",h),t.R7$(3),t.Y8G("ngIf",a.notifications.length>0)}},dependencies:[_.MD,_.Sq,_.bT],styles:[".notification-bell-container[_ngcontent-%COMP%]{position:relative;display:inline-block}.notification-bell[_ngcontent-%COMP%]{position:relative;background:none;border:none;padding:.5rem;border-radius:50%;cursor:pointer;transition:all .2s ease;color:#6b7280}.notification-bell[_ngcontent-%COMP%]:hover{background:#f3f4f6;color:#374151}.notification-bell.has-unread[_ngcontent-%COMP%]{color:#3b82f6;animation:_ngcontent-%COMP%_pulse 2s infinite}.notification-bell[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:20px;height:20px}.notification-badge[_ngcontent-%COMP%]{position:absolute;top:-2px;right:-2px;background:#ef4444;color:#fff;font-size:.75rem;font-weight:600;padding:.125rem .375rem;border-radius:10px;min-width:18px;text-align:center;line-height:1}.notifications-dropdown[_ngcontent-%COMP%]{position:absolute;top:calc(100% + .5rem);right:0;width:400px;max-height:500px;background:white;border-radius:12px;box-shadow:0 10px 25px #00000026;border:1px solid #e5e7eb;z-index:1000;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all .2s ease}.notifications-dropdown.show[_ngcontent-%COMP%]{opacity:1;visibility:visible;transform:translateY(0)}.notifications-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:1rem;border-bottom:1px solid #e5e7eb}.notifications-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1rem;font-weight:600;color:#111827}.notifications-header[_ngcontent-%COMP%]   .notifications-actions[_ngcontent-%COMP%]{display:flex;gap:.5rem}.notifications-header[_ngcontent-%COMP%]   .notifications-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{background:none;border:none;padding:.25rem;border-radius:4px;cursor:pointer;color:#6b7280;transition:all .2s ease}.notifications-header[_ngcontent-%COMP%]   .notifications-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:#f3f4f6;color:#374151}.notifications-header[_ngcontent-%COMP%]   .notifications-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:16px;height:16px}.notifications-list[_ngcontent-%COMP%]{max-height:350px;overflow-y:auto}.notification-item[_ngcontent-%COMP%]{display:flex;padding:1rem;border-bottom:1px solid #f3f4f6;cursor:pointer;transition:background-color .2s ease}.notification-item[_ngcontent-%COMP%]:hover{background:#f9fafb}.notification-item.unread[_ngcontent-%COMP%]{background:#eff6ff;border-left:3px solid #3b82f6}.notification-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.notification-icon[_ngcontent-%COMP%]{flex-shrink:0;width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;margin-right:.75rem}.notification-icon.update[_ngcontent-%COMP%]{background:#dbeafe;color:#1d4ed8}.notification-icon.info[_ngcontent-%COMP%]{background:#e0f2fe;color:#0369a1}.notification-icon.warning[_ngcontent-%COMP%]{background:#fef3c7;color:#d97706}.notification-icon.error[_ngcontent-%COMP%]{background:#fee2e2;color:#dc2626}.notification-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:20px;height:20px}.notification-content[_ngcontent-%COMP%]{flex:1;min-width:0}.notification-content[_ngcontent-%COMP%]   .notification-title[_ngcontent-%COMP%]{font-weight:600;color:#111827;font-size:.875rem;margin-bottom:.25rem}.notification-content[_ngcontent-%COMP%]   .notification-message[_ngcontent-%COMP%]{color:#6b7280;font-size:.8125rem;line-height:1.4;margin-bottom:.5rem}.notification-content[_ngcontent-%COMP%]   .notification-meta[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;font-size:.75rem}.notification-content[_ngcontent-%COMP%]   .notification-meta[_ngcontent-%COMP%]   .notification-entity[_ngcontent-%COMP%]{color:#3b82f6;font-weight:500}.notification-content[_ngcontent-%COMP%]   .notification-meta[_ngcontent-%COMP%]   .notification-time[_ngcontent-%COMP%]{color:#9ca3af}.notification-actions[_ngcontent-%COMP%]{flex-shrink:0;margin-left:.5rem}.notification-actions[_ngcontent-%COMP%]   .mark-read-btn[_ngcontent-%COMP%]{background:none;border:none;padding:.25rem;border-radius:4px;cursor:pointer;color:#3b82f6;transition:all .2s ease}.notification-actions[_ngcontent-%COMP%]   .mark-read-btn[_ngcontent-%COMP%]:hover{background:#dbeafe}.notification-actions[_ngcontent-%COMP%]   .mark-read-btn[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:14px;height:14px}.no-notifications[_ngcontent-%COMP%]{text-align:center;padding:3rem 2rem;color:#9ca3af}.no-notifications[_ngcontent-%COMP%]   .no-notifications-icon[_ngcontent-%COMP%]{margin-bottom:1rem;color:#d1d5db}.no-notifications[_ngcontent-%COMP%]   .no-notifications-icon[_ngcontent-%COMP%]   svg[_ngcontent-%COMP%]{width:48px;height:48px}.no-notifications[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:.875rem}.notifications-footer[_ngcontent-%COMP%]{padding:1rem;border-top:1px solid #e5e7eb;text-align:center}.notifications-footer[_ngcontent-%COMP%]   .view-all-btn[_ngcontent-%COMP%]{background:#3b82f6;color:#fff;border:none;padding:.5rem 1rem;border-radius:6px;font-size:.8125rem;font-weight:500;cursor:pointer;transition:background-color .2s ease}.notifications-footer[_ngcontent-%COMP%]   .view-all-btn[_ngcontent-%COMP%]:hover{background:#2563eb}@keyframes _ngcontent-%COMP%_pulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}@media (max-width: 768px){.notifications-dropdown[_ngcontent-%COMP%]{width:350px;right:-50px}}@media (max-width: 480px){.notifications-dropdown[_ngcontent-%COMP%]{width:calc(100vw - 2rem);right:-50px;left:50px}}"]})}}return n})()}}]);